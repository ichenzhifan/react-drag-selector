(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.Selector = f()}})(function(){var define,module,exports;return (function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
(function (global){
"use strict";

const React = (typeof window !== "undefined" ? window['React'] : typeof global !== "undefined" ? global['React'] : null);
const ReactDOM = (typeof window !== "undefined" ? window['ReactDOM'] : typeof global !== "undefined" ? global['ReactDOM'] : null);

const Shortcut = require('./shortcut');
const KeyCodeMap = require('./shortcut/key_code_map');

const Selection = React.createClass({
    displayName: 'Selection',


    getDefaultProps() {
        return {
            enable: true,
            onSelectionChange: () => {}
        };
    },

    getInitialState() {
        return {
            mouseDown: false,
            selecting: false,
            downInSelectionItem: false,

            startPoint: null,
            endPoint: null,

            appendMode: false
        };
    },

    componentWillMount() {

        let that = this;
        this.originSelectedItems = new Set();
        this.selectedItems = new Set();

        Shortcut.addListener([KeyCodeMap.ctrl], this.handleSwitchAppendMode.bind(this, true));
        Shortcut.addListener([KeyCodeMap.shift], this.handleSwitchAppendMode.bind(this, true));
        // 全选监听
        // Shortcut.addListener([KeyCodeMap.ctrl, KeyCodeMap.a], () => {
        //     for (let key in that.refs) {
        //         if (key !=="selectionArea")
        //             that.selectedItems.add(key);
        //     }
        //     that.forceUpdate();
        // });
        window.addEventListener('keyup', this.handleSwitchAppendMode.bind(this, false));
    },

    render() {

        const thisState = this.state;
        const className = "select-area" + (thisState.selecting ? " selecting" : "");

        return React.createElement(
            'div',
            { ref: 'selectionArea', key: 'selectionArea', className: className, onMouseDown: this.handleMouseDown },
            this.handleRenderChildren(),
            this.handleRenderSelectRectangle()
        );
    },

    componentWillReceiveProps(nextProps) {
        if (!nextProps.enable || nextProps.children.length !== this.props.children.length) this.selectedItems = new Set();

        this.forceUpdate();
    },

    componentWillUmmount() {
        Shortcut.removeListener([KeyCodeMap.ctrl]);
        Shortcut.removeListener([KeyCodeMap.shift]);
        Shortcut.removeListener([KeyCodeMap.ctrl, KeyCodeMap.a]);
        window.removeEventListener('keyup', this.handleSwitchAppendMode);
    },

    handleSwitchAppendMode(appendMode) {
        if (this.props.enable) this.setState({ appendMode });
    },

    handleMouseDown(event) {

        if (!this.props.enable) return;

        const thisState = this.state;
        const thisRefs = this.refs;
        const startPoint = {
            x: event.pageX,
            y: event.pageY
        };

        let downInSelectionItem = false;

        for (let key in thisRefs) {
            if (key !== "selectionArea") {
                let selectionItem = thisRefs[key];
                let selectionItemRectAngle = {
                    left: selectionItem.getBoundingClientRect().left,
                    top: selectionItem.getBoundingClientRect().top,
                    width: selectionItem.getBoundingClientRect().width,
                    height: selectionItem.getBoundingClientRect().height
                };

                if (this.handleCalcBoxIntercets({
                    top: startPoint.y,
                    left: startPoint.x,
                    width: 0,
                    height: 0
                }, selectionItemRectAngle)) {
                    downInSelectionItem = key;
                    if (this.selectedItems.size === 0 || thisState.appendMode) {
                        this.selectedItems.add(key);
                    } else if (!this.selectedItems.has(key)) {
                        this.selectedItems = new Set([key]);
                    }
                    break;
                }
            }
        }

        this.setState({
            mouseDown: true,
            downInSelectionItem,
            startPoint
        });

        window.addEventListener('mouseup', this.handleMouseUp);
        window.addEventListener('mousemove', this.handleMouseMove);
        window.removeEventListener('mousedown', this.handleMouseDownOutSide);
    },

    handleCalcBoxIntercets(boxA, boxB) {
        if (boxA.left <= boxB.left + boxB.width && boxA.left + boxA.width >= boxB.left && boxA.top <= boxB.top + boxB.height && boxA.top + boxA.height >= boxB.top) {
            return true;
        }

        return false;
    },

    handleMouseMove(event) {

        const that = this;
        const thisState = this.state;
        const thisRefs = this.refs;

        const parentNode = this.refs.selectionArea;
        const startPoint = thisState.startPoint;
        const endPoint = {
            x: event.pageX,
            y: event.pageY
        };

        const selectBoxStyle = {
            left: Math.min(startPoint.x, endPoint.x) - parentNode.offsetLeft - Math.abs(parentNode.offsetLeft - parentNode.getBoundingClientRect().left),
            top: Math.min(startPoint.y, endPoint.y) - parentNode.offsetTop,
            width: Math.abs(startPoint.x - endPoint.x),
            height: Math.abs(startPoint.y - endPoint.y)
        };

        if (!thisState.mouseDown || thisState.downInSelectionItem) return;

        for (let key in thisRefs) {
            if (key !== "selectionArea") {
                let selectionItem = thisRefs[key];
                let selectionItemRectAngle = {
                    left: selectionItem.offsetLeft,
                    top: selectionItem.offsetTop,
                    width: selectionItem.clientWidth,
                    height: selectionItem.clientHeight
                };

                if (this.handleCalcBoxIntercets(selectBoxStyle, selectionItemRectAngle)) {
                    this.selectedItems.add(key);
                } else if (!thisState.appendMode) {
                    this.selectedItems.delete(key);
                }
            }
        }

        this.setState({
            selecting: true,
            endPoint: {
                x: event.pageX,
                y: event.pageY
            },
            selectBoxStyle
        });
    },

    handleRenderSelectRectangle() {

        const thisState = this.state;

        if (!thisState.selecting) return null;

        return React.createElement('div', { className: 'select-rectangle', style: thisState.selectBoxStyle });
    },

    handleRenderChildren() {

        let that = this;
        let index = 0;
        let selectionItemStatus = {};
        let originSelectedItems = this.originSelectedItems;
        let selectedItems = this.selectedItems;
        let diff;

        const newChildren = React.Children.map(this.props.children, childNode => {
            let tempNode = React.cloneElement(childNode);
            let className = "selection-item" + (selectedItems.has(childNode.key) ? " selected" : "");

            selectionItemStatus[childNode.key] = selectedItems.has(childNode.key);

            return React.createElement(
                'div',
                {
                    className: className,
                    ref: childNode.key ? childNode.key : index++,
                    draggable: true,
                    onDragStart: that.handleDragStart
                },
                tempNode
            );
        });

        if (originSelectedItems.size > selectedItems.size) diff = new Set([...originSelectedItems].filter(x => !selectedItems.has(x)));else diff = new Set([...selectedItems].filter(x => !originSelectedItems.has(x)));

        if (diff.size) {
            this.originSelectedItems = new Set(this.selectedItems);
            this.props.onSelectionChange(selectionItemStatus);
        }

        return newChildren;
    },

    handleDragStart(event) {
        if (this.selectedItems.size) {
            event.dataTransfer.setData("dragKeyList", Array.from(this.selectedItems));
        } else {
            event.dataTransfer.setData("dragKeyList", [this.downInSelectionItem]);
        }
    },

    handleMouseUp() {

        if (!this.state.selecting && !this.state.downInSelectionItem) this.selectedItems = new Set();

        this.setState({
            mouseDown: false,
            selecting: false,
            startPoint: null,
            endPoint: null
        });

        window.removeEventListener('mouseup', this.handleMouseUp);
        window.removeEventListener('mousemove', this.handleMouseMove);
    }
});

module.exports = Selection;
}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"./shortcut":2,"./shortcut/key_code_map":3}],2:[function(require,module,exports){
(function (global){
"use strict";

const Immutable = (typeof window !== "undefined" ? window['Immutable'] : typeof global !== "undefined" ? global['Immutable'] : null);
let listenList = Immutable.Map({});
let keyDownGroup = [];

const getKeyGroupString = keyGroupArray => {
    let keyGroup = Array.from(keyGroupArray);
    keyGroup.sort();
    return keyGroup.join(',');
};

/**
 * 添加快捷键监听
 * kg      Array    快捷键组合
 * handler Function 被监听的事件
 **/
const addListener = (kg, handler) => {
    let keyGroup = getKeyGroupString(kg);
    listenList = listenList.update(keyGroup, handlerList => handlerList ? handlerList.push(handler) : Immutable.List([handler]));
};

/**
 * 添加快捷键监听
 * kg            Array    快捷键组合
 * deleteHandler Function 要被移除监听的事件（如果为空则移除该快捷键组合的所有事件）
 **/
const removeListener = (kg, deleteHandler) => {
    let keyGroup = getKeyGroupString(kg);
    if (listenList.has(keyGroup)) {
        if (deleteHandler) {
            listenList = listenList.update(keyGroup, handlerList => handlerList.filter(handler => handler !== deleteHandler));
        } else {
            listenList = listenList.delete(keyGroup);
        }
    }
};

window.addEventListener('keydown', event => {
    keyDownGroup = Array.from(new Set([...keyDownGroup, event.keyCode]));
    let keyDownGroupString = getKeyGroupString(keyDownGroup);
    if (listenList.has(keyDownGroupString)) {
        listenList.get(keyDownGroupString).forEach(handler => {
            handler();
        });
    }
});

window.addEventListener('keyup', event => {
    keyDownGroup.pop();
});

module.exports = {
    addListener,
    removeListener
};
}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{}],3:[function(require,module,exports){
"use strict";

module.exports = {
    backspace: 8,
    tab: 9,
    enter: 13,
    shift: 16,
    ctrl: 17,
    alt: 18,
    pause: 19,
    break: 19,
    capsLock: 20,
    escape: 27,
    pageUp: 33,
    pageDown: 34,
    end: 35,
    home: 36,
    leftArrow: 37,
    upArrow: 38,
    rightArrow: 39,
    downArrow: 40,
    insert: 45,
    delete: 46,
    '0': 48,
    '1': 49,
    '2': 50,
    '3': 51,
    '4': 52,
    '5': 53,
    '6': 54,
    '7': 55,
    '8': 56,
    '9': 57,
    a: 65,
    b: 66,
    c: 67,
    d: 68,
    e: 69,
    f: 70,
    g: 71,
    h: 72,
    i: 73,
    j: 74,
    k: 75,
    l: 76,
    m: 77,
    n: 78,
    o: 79,
    p: 80,
    q: 81,
    r: 82,
    s: 83,
    t: 84,
    u: 85,
    v: 86,
    w: 87,
    x: 88,
    y: 89,
    z: 90,
    window: {
        left: 91,
        right: 92
    },
    meta: {
        left: 91,
        right: 93
    },
    select: 93,
    numPad0: 96,
    numPad1: 97,
    numPad2: 98,
    numPad3: 99,
    numPad4: 100,
    numPad5: 101,
    numPad6: 102,
    numPad7: 103,
    numPad8: 104,
    numPad9: 105,
    multiply: 106,
    add: 107,
    subtract: 109,
    decimalPoint: 110,
    divide: 111,
    f1: 112,
    f2: 113,
    f3: 114,
    f4: 115,
    f5: 116,
    f6: 117,
    f7: 118,
    f8: 119,
    f9: 120,
    f10: 121,
    f11: 122,
    f12: 123,
    numLock: 144,
    scrollLock: 145,
    semicolon: 186,
    equalSign: 187,
    comma: 188,
    dash: 189,
    period: 190,
    forwardSlash: 191,
    graveAccent: 192,
    openBracket: 219,
    backSlash: 220,
    closeBraket: 221,
    singleQuote: 222
};
},{}]},{},[1])(1)
});